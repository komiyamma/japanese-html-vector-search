# 要件定義書

## 概要

日本語で記述されたHTMLファイル群をベクトル化し、類似度や関係性をスコア化するためのベクトル検索システムを構築します。このシステムは、page-***-*****.html形式のファイルを処理し、ベクトルデータをSQLiteデータベースに保存して効率的な検索を可能にします。

## 要件

### 要件1：日本語HTMLコンテンツのベクトル化

**ユーザーストーリー:** 開発者として、日本語HTMLコンテンツをベクトル化したい。そうすることで、ドキュメントに対してセマンティック類似度検索を実行できるようになる。

#### 受け入れ基準

1. システムがHTMLファイルを処理する時、HTML構造からメインコンテンツのテキストを抽出すること
2. システムがテキストコンテンツを抽出する時、日本語テキストエンコーディングを適切に処理すること
3. システムがテキストコンテンツを処理する時、日本語対応モデルを使用してベクトル埋め込みを生成すること
4. もしHTMLファイルが1,000文字未満の有効なコンテンツを含む場合、システムは警告をログに記録するが、ファイルは処理すること
5. システムが10,000文字から30,000文字のファイルに遭遇する時、メモリ問題なく効率的に処理すること

### 要件2：SQLiteでのベクトルデータ保存

**ユーザーストーリー:** 開発者として、適切なキーマッピングでベクトルデータをSQLiteに保存したい。そうすることで、ベクトル化されたコンテンツを効率的に取得・クエリできるようになる。

#### 受け入れ基準

1. システムが「page-bushou-羽柴秀吉.html」という名前のファイルを処理する時、「page-bushou-羽柴秀吉」をデータベースキーとして使用すること
2. ベクトルデータを保存する時、システムはキーが拡張子なしのファイル名で値がベクトルデータのキー・バリューペアでSQLiteテーブルを作成すること
3. ベクトルを保存する時、システムは効率的にクエリできる形式でベクトルデータをシリアライズすること
4. データベースに既にキーが存在する場合、システムは重複を作成するのではなく既存のレコードを更新すること
5. ベクトルデータを保存する時、システムはデータ整合性を確保し、データベース接続エラーを適切に処理すること

### 要件3：ドキュメント間の類似度計算

**ユーザーストーリー:** 開発者として、ドキュメント間の類似度スコアを計算したい。そうすることで、セマンティックな意味に基づいて関連コンテンツを見つけることができる。

#### 受け入れ基準

1. 2つのベクトルを比較する時、システムはコサイン類似度スコアを計算すること
2. 類似度を計算する時、システムは0から1の間のスコアを返し、1は同一コンテンツを示すこと
3. 類似ドキュメントをクエリする時、システムは類似度スコアでランク付けされた結果を返すこと
4. 類似度計算を実行する時、システムはゼロベクトルや同一ベクトルなどのエッジケースを処理すること
5. 大量の比較を処理する時、システムはタイムアウト問題を避けるためにパフォーマンスを最適化すること

### 要件4：バッチ処理スクリプト

**ユーザーストーリー:** 開発者として、バッチ処理スクリプトが欲しい。そうすることで、ディレクトリ内のすべてのHTMLファイルを効率的にベクトル化できる。

#### 受け入れ基準

1. バッチスクリプトを実行する時、現在のディレクトリ内のすべてのpage-***-*****.htmlファイルを自動的に発見すること
2. 複数のファイルを処理する時、システムは長時間実行される操作に対して進捗インジケーターを表示すること
3. ファイル処理エラーに遭遇する時、システムはエラーをログに記録し、残りのファイルの処理を続行すること
4. バッチ処理が完了する時、システムは処理されたファイルとエラーの概要を提供すること
5. スクリプトを複数回実行する時、明示的に再処理を要求されない限り、既に処理されたファイルをスキップすること

### 要件5：ベクトルデータベースのクエリ

**ユーザーストーリー:** 開発者として、ベクトルデータベースをクエリしたい。そうすることで、指定された入力やドキュメントに類似したドキュメントを見つけることができる。

#### 受け入れ基準

1. テキストクエリを提供する時、システムはクエリテキストをベクトル化し、類似ドキュメントを見つけること
2. ドキュメントキーを提供する時、システムはその特定のドキュメントに類似したドキュメントを見つけること
3. 類似ドキュメントをクエリする時、システムは設定可能な数の上位結果を返すこと
4. 閾値を超える類似ドキュメントが見つからない場合、システムは空の結果セットを返すこと
5. データベースをクエリする時、システムはデータベース接続問題を処理し、意味のあるエラーメッセージを提供すること